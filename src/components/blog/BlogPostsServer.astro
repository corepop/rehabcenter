---
import Grid from '~/components/blog/Grid.astro';
import Headline from '~/components/blog/Headline.astro';

// This function from blog-wordpress.ts properly generates permalinks using POST_PERMALINK_PATTERN
const generatePermalink = async ({
  slug,
  publishDate,
  category,
}: {
  slug: string;
  publishDate: Date;
  category: string | undefined;
}) => {
  const { POST_PERMALINK_PATTERN, trimSlash } = await import('~/utils/permalinks');

  const year = String(publishDate.getFullYear()).padStart(4, '0');
  const month = String(publishDate.getMonth() + 1).padStart(2, '0');
  const day = String(publishDate.getDate()).padStart(2, '0');
  const hour = String(publishDate.getHours()).padStart(2, '0');
  const minute = String(publishDate.getMinutes()).padStart(2, '0');
  const second = String(publishDate.getSeconds()).padStart(2, '0');

  const permalink = POST_PERMALINK_PATTERN.replace('%slug%', slug)
    .replace('%category%', category || '')
    .replace('%year%', year)
    .replace('%month%', month)
    .replace('%day%', day)
    .replace('%hour%', hour)
    .replace('%minute%', minute)
    .replace('%second%', second);

  return permalink
    .split('/')
    .map((el) => trimSlash(el))
    .filter((el) => !!el)
    .join('/');
};

// Fetch posts server-side using REST API directly
const WORDPRESS_API_URL = 'https://blogg.rygg.nu/wp-json/wp/v2/posts';
const response = await fetch(`${WORDPRESS_API_URL}?per_page=12&_embed`);
const wpPosts = await response.json();

// Convert WordPress posts to our Post type with proper permalinks
const posts = await Promise.all(
  wpPosts.map(async (wpPost: any) => {
    const post = {
      slug: wpPost.slug,
      publishDate: new Date(wpPost.date),
      title: wpPost.title.rendered,
      excerpt: wpPost.excerpt.rendered.replace(/<[^>]*>/g, '').trim(),
      image: wpPost._embedded?.['wp:featuredmedia']?.[0]?.source_url,
      category: {
        slug: wpPost._embedded?.['wp:term']?.[0]?.[0]?.slug,
        title: wpPost._embedded?.['wp:term']?.[0]?.[0]?.name,
      },
      author: wpPost._embedded?.['wp:term']?.[0]?.[0]?.name || 'Johny Åhman',
      content: wpPost.content.rendered.replace(/<[^>]*>/g, '').trim(),
      draft: wpPost.status !== 'publish',
    };

    const permalink = await generatePermalink({
      slug: post.slug,
      publishDate: post.publishDate,
      category: post.category?.slug,
    });

    return {
      ...post,
      permalink,
    };
  })
);

// Filter out draft posts
const publishedPosts = posts.filter((post) => !post.draft);
---

<section class="px-6 py-12 sm:py-16 lg:py-20">
  <div class="mx-auto max-w-7xl">
    <Headline
      title="Blogg"
      subtitle="Praktiska råd, övningar och fördjupningar om vanliga besvär i rygg, nacke, axlar, knän och fötter."
    />

    {
      publishedPosts.length > 0 ? (
        <Grid posts={publishedPosts} />
      ) : (
        <div class="text-center py-8">
          <p class="text-muted dark:text-slate-400 max-w-2xl mx-auto">Inga blogginlägg tillgängliga just nu.</p>
        </div>
      )
    }
  </div>
</section>
